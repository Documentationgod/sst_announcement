"use strict";(()=>{var e={};e.id=610,e.ids=[610],e.modules={10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},84297:e=>{e.exports=require("async_hooks")},55511:e=>{e.exports=require("crypto")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},11737:e=>{e.exports=import("drizzle-orm")},1214:e=>{e.exports=import("drizzle-orm/node-postgres")},58025:e=>{e.exports=import("drizzle-orm/pg-core")},64939:e=>{e.exports=import("pg")},2502:e=>{e.exports=import("prettier/plugins/html")},83505:e=>{e.exports=import("prettier/standalone")},77598:e=>{e.exports=require("node:crypto")},57075:e=>{e.exports=require("node:stream")},16617:(e,t,n)=>{n.a(e,async(e,i)=>{try{n.r(t),n.d(t,{patchFetch:()=>l,routeModule:()=>c,serverHooks:()=>p,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>m});var r=n(42706),s=n(28203),a=n(45994),o=n(47150),u=e([o]);o=(u.then?(await u)():u)[0];let c=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/announcements/route",pathname:"/api/announcements",filename:"route",bundlePath:"app/api/announcements/route"},resolvedPagePath:"E:\\Project\\sst_announcement\\app\\api\\announcements\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:d,workUnitAsyncStorage:m,serverHooks:p}=c;function l(){return(0,a.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:m})}i()}catch(e){i(e)}})},47150:(e,t,n)=>{n.a(e,async(e,i)=>{try{n.r(t),n.d(t,{GET:()=>h,POST:()=>f});var r=n(39187),s=n(60517),a=n(27644),o=n(74272),u=n(70366),l=n(88374),c=n(44218),d=n(11770),m=n(66980),p=n(7329),y=n(11737),g=e([a,o,d,m,y]);async function h(e){try{await (0,s.ay)(e,s.Nw);let{searchParams:t}=new URL(e.url),n=t.get("limit")?parseInt(t.get("limit"),10):void 0,i=t.get("offset")?parseInt(t.get("offset"),10):void 0,o=await (0,a.ir)({limit:n&&n>0&&n<=100?n:void 0,offset:i&&i>=0?i:void 0});return r.NextResponse.json({success:!0,data:o})}catch(e){return r.NextResponse.json({success:!1,error:e.message||"Internal server error"},{status:e.status||500})}}async function f(e){try{await (0,s.ay)(e,s.uZ);let t=await (0,o.oC)(e,{enforceDomain:!0});(0,u.eU)(t),(0,o.ZT)(t),await w();let n=await e.json(),i=(0,l.cH)(n);if(i.length>0)throw new c.v7("Validation failed",i);let{title:g,description:h,category:f,expiry_date:x,scheduled_at:E,reminder_time:T,priority_until:A,is_active:R=!0,status:$="active",send_email:q=!1,send_tv:L=!1}=n,S=(0,d.Lf)(),I=await _(S),D=new Date,N=E?new Date(E):null,b=A?new Date(A):null,k=N&&!isNaN(N.getTime())?N:null,C=b&&!isNaN(b.getTime())?b:null,M=!!k&&k>D,U=!!C&&C>D,P={title:g,description:h,category:f,authorId:t.id,expiryDate:x?new Date(x):null,scheduledAt:E?new Date(E):null,reminderTime:T?new Date(T):null,isActive:!M&&(!!U||R),status:U?"urgent":M?"scheduled":$,sendEmail:q,emailSent:!1,sendTV:L};I&&(P.priorityUntil=C);let j=await v(S,P,I),O=!1,F=null;if(q&&!M)try{let e=["mohammed.24bcs10278@sst.scaler.com"];if(e.length>0){let t=await (0,p.sendAnnouncementEmail)({title:g,description:h,category:f,recipientEmails:e,expiryDate:x||null,scheduledAt:E||null});O=t.success,F=t.message||t.error||null,t.success&&await S.update(m.announcements).set({emailSent:!0}).where((0,y.eq)(m.announcements.id,j.id))}}catch(e){console.error("Error sending announcement email:",e),F=e instanceof Error?e.message:"Failed to send email"}return r.NextResponse.json({success:!0,data:{announcement:(0,a._n)(j),emailSent:O,emailMessage:F}},{status:201})}catch(e){return r.NextResponse.json({success:!1,error:e.message||"Internal server error"},{status:e.status||500})}}[a,o,d,m,y]=g.then?(await g)():g;let A="unknown",R=!1,$=null;async function w(){return $||($=(async()=>{let e=(0,d.Lf)();await Promise.all([_(e),x(e)])})())}async function _(e){if("supported"===A)return!0;if("unsupported"===A)return!1;try{let t=await e.execute((0,y.sql)`
      SELECT column_name FROM information_schema.columns
      WHERE table_name = 'announcements' AND column_name = 'priority_until'
      LIMIT 1
    `);if(t?.rows?.length>0)return A="supported",!0;await e.execute((0,y.sql)`ALTER TABLE announcements ADD COLUMN IF NOT EXISTS priority_until TIMESTAMPTZ`);let n=await e.execute((0,y.sql)`
      SELECT column_name FROM information_schema.columns
      WHERE table_name = 'announcements' AND column_name = 'priority_until'
      LIMIT 1
    `);if(n?.rows?.length>0)return A="supported",!0;return A="unsupported",!1}catch(e){return console.warn("Unable to add/check priority_until column; falling back without priority support",e),A="unsupported",!1}}async function x(e){if(!R)try{let t=await e.execute((0,y.sql)`
      SELECT 1 FROM pg_type WHERE typname = 'announcement_status' LIMIT 1
    `);if(t?.rows?.length>0){let t=await e.execute((0,y.sql)`
        SELECT 1 FROM pg_enum 
        WHERE enumlabel = 'urgent' 
        AND enumtypid = (SELECT oid FROM pg_type WHERE typname = 'announcement_status')
        LIMIT 1
      `);if(!t?.rows?.length)try{await e.execute((0,y.sql)`ALTER TYPE announcement_status ADD VALUE 'urgent'`)}catch(t){let e=t?.message||String(t);e.includes("already exists")||console.warn("Could not add urgent to enum:",e)}}R=!0}catch(e){console.warn("Could not ensure urgent status in enum (may not be needed)",e),R=!0}}async function v(e,t,n){if(n)try{let[n]=await e.insert(m.announcements).values(t).returning();return n}catch(n){if(function(e){let t=(e instanceof Error?e.message:String(e)).toLowerCase();return t.includes("priority_until")||t.includes("priority until")||t.includes("column")&&t.includes("does not exist")}(n))A="unsupported";else if(E(n)&&"urgent"===t.status){console.warn("Urgent status not supported, using active instead");let n={...t,status:"active"},[i]=await e.insert(m.announcements).values(n).returning();return i}else throw n}let i=(0,d.d_)(),r="urgent"===t.status?"active":t.status??"active";try{let e=await i.query({text:`
        INSERT INTO announcements (
          title,
          description,
          category,
          author_id,
          expiry_date,
          scheduled_at,
          reminder_time,
          is_active,
          status,
          send_email,
          email_sent,
          send_tv
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
        RETURNING *
      `,values:[t.title,t.description,t.category,t.authorId,t.expiryDate??null,t.scheduledAt??null,t.reminderTime??null,t.isActive??!0,r,t.sendEmail??!1,t.emailSent??!1,t.sendTV??!1]});if(!e.rows?.length)throw Error("Failed to insert announcement without priority column");return T(e.rows[0])}catch(e){if(E(e)&&"active"!==r){let e=await i.query({text:`
          INSERT INTO announcements (
            title,
            description,
            category,
            author_id,
            expiry_date,
            scheduled_at,
            reminder_time,
            is_active,
            status,
            send_email,
            email_sent,
            send_tv
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
          RETURNING *
        `,values:[t.title,t.description,t.category,t.authorId,t.expiryDate??null,t.scheduledAt??null,t.reminderTime??null,t.isActive??!0,"active",t.sendEmail??!1,t.emailSent??!1,t.sendTV??!1]});if(!e.rows?.length)throw Error("Failed to insert announcement");return T(e.rows[0])}throw e}}function E(e){let t=(e instanceof Error?e.message:String(e)).toLowerCase();return t.includes("invalid input value for enum")||t.includes("invalid enum value")}function T(e){return{id:e.id,title:e.title,description:e.description,category:e.category,authorId:e.author_id,createdAt:e.created_at,updatedAt:e.updated_at,expiryDate:e.expiry_date,scheduledAt:e.scheduled_at,reminderTime:e.reminder_time,isActive:e.is_active,status:e.status,viewsCount:e.views_count??0,clicksCount:e.clicks_count??0,sendEmail:e.send_email??!1,emailSent:e.email_sent??!1,sendTV:e.send_tv??!1,priorityUntil:null}}i()}catch(e){i(e)}})},27644:(e,t,n)=>{n.a(e,async(e,i)=>{try{n.d(t,{LR:()=>d,MZ:()=>c,_n:()=>u,ir:()=>l});var r=n(11737),s=n(11770),a=n(66980),o=e([r,s,a]);function u(e){return{id:e.id,title:e.title,description:e.description,category:e.category,author_id:e.authorId,created_at:e.createdAt,updated_at:e.updatedAt,expiry_date:e.expiryDate,scheduled_at:e.scheduledAt,reminder_time:e.reminderTime,is_active:e.isActive,status:e.status,views_count:e.viewsCount,clicks_count:e.clicksCount,send_email:e.sendEmail,email_sent:e.emailSent,send_tv:e.sendTV,priority_until:e.priorityUntil}}async function l(e){let t=(0,s.Lf)().select().from(a.announcements).orderBy((0,r.desc)(a.announcements.createdAt));return e?.limit!==void 0&&(t=t.limit(e.limit)),e?.offset!==void 0&&(t=t.offset(e.offset)),(await t).map(u)}async function c(e){let t=(0,s.Lf)(),n=await t.select().from(a.announcements).where((0,r.eq)(a.announcements.id,e)).limit(1);return n.length>0?u(n[0]):null}async function d(){let e=(0,s.Lf)();return(await e.select().from(a.announcements).where((0,r.eq)(a.announcements.sendTV,!0)).orderBy((0,r.desc)(a.announcements.createdAt)).limit(5)).map(u)}[r,s,a]=o.then?(await o)():o,i()}catch(e){i(e)}})},60517:(e,t,n)=>{n.d(t,{Nw:()=>a,ay:()=>s,uZ:()=>o});var i=n(44218);let r=new Map;async function s(e,t){let n=function(e){let t=e.headers.get("x-forwarded-for");return t?t.split(",")[0]?.trim()||"unknown":e.headers.get("x-real-ip")||e.ip||"unknown"}(e),s=`${t.keyPrefix}:${n}`,a=Date.now(),o=r.get(s);if(!o||o.expiresAt<a){r.set(s,{count:1,expiresAt:a+t.windowMs});return}if(o.count>=t.max)throw new i.qQ("Too many requests, please try again later.");o.count+=1,r.set(s,o)}let a={windowMs:9e5,max:100,keyPrefix:"general"},o={windowMs:9e5,max:200,keyPrefix:"admin"}},88374:(e,t,n)=>{function i(e){let t=[];e.title&&"string"==typeof e.title&&0!==e.title.trim().length?e.title.length>200&&t.push({field:"title",message:"Title must be less than 200 characters"}):t.push({field:"title",message:"Title is required and must be a non-empty string"}),e.description&&"string"==typeof e.description&&0!==e.description.trim().length?e.description.length>5e3&&t.push({field:"description",message:"Description must be less than 5000 characters"}):t.push({field:"description",message:"Description is required and must be a non-empty string"}),e.category&&"string"==typeof e.category||t.push({field:"category",message:"Category is required"});let n=["college","tech","tech-events","tech-workshops","other"];e.category&&!n.includes(e.category.toLowerCase())&&t.push({field:"category",message:`Category must be one of: ${n.join(", ")}`}),e.expiry_date&&!r(e.expiry_date)&&t.push({field:"expiry_date",message:"Expiry date must be a valid date"}),e.scheduled_at&&!r(e.scheduled_at)&&t.push({field:"scheduled_at",message:"Scheduled date must be a valid date"}),e.reminder_time&&!r(e.reminder_time)&&t.push({field:"reminder_time",message:"Reminder time must be a valid date"}),e.priority_until&&!r(e.priority_until)&&t.push({field:"priority_until",message:"Priority until must be a valid date"}),e.emergency_expires_at&&!r(e.emergency_expires_at)&&t.push({field:"emergency_expires_at",message:"Emergency expiration time must be a valid date"}),void 0!==e.is_active&&"boolean"!=typeof e.is_active&&t.push({field:"is_active",message:"is_active must be a boolean"}),e.status&&"string"!=typeof e.status&&t.push({field:"status",message:"Status must be a string"});let i=["active","scheduled","urgent","expired"];return e.status&&!i.includes(e.status.toLowerCase())&&t.push({field:"status",message:`Status must be one of: ${i.join(", ")}`}),t}function r(e){let t=new Date(e);return t instanceof Date&&!isNaN(t.getTime())}n.d(t,{cH:()=>i})}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),i=t.X(0,[680,38,883,684,329],()=>n(16617));module.exports=i})();